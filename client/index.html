<html>

<head>
    <title>HTTP Hound</title>
</head>

<body>
    <div id="statuses"></div>
    <div id="links"></div>
    <div id="detail"></div>

    <script src="./bower_components/jquery/jquery.js"></script>
    <script src="./bower_components/q/q.js"></script>
    <script src="./bower_components/uri.js/src/URI.js"></script>
    <script src="./bower_components/hyperagent/dist/hyperagent.js"></script>

    <script>
        $(document).ready(function() {

            renderTable('http://localhost:8080');

            $('#links').on('click', 'a', function(event) {
                event.preventDefault();
                var href = $(event.target).attr("data-next");
                renderTable('http://localhost:8080' + href);
                return false;
            });

            $('#statuses').on('click', 'a', function(event) {
                event.preventDefault();
                var href = $(event.target).attr("data-next");
                renderDetails('http://localhost:8080' + href);
                return false;
            });

        });

        function renderTable(url) {
            clear();

            var api = new Hyperagent.Resource(url);
            api.fetch().then(function(root) {
                var $target = $('#statuses');

                $table = $('<table>');

                var row = $('<tr>');
                var $cell = $('<th>');
                $cell.text("Code");
                $cell.appendTo(row);
                $cell = $('<th>');
                $cell.text("Description");
                $cell.appendTo(row);
                $cell = $('<th>');
                $cell.text("Meaning");
                $cell.appendTo(row);
                $cell = $('<th>');
                $cell.text("Image");
                $cell.appendTo(row);
                row.appendTo($table);

                root.embedded.statuses.forEach(function logArrayElements(element, index, array) {
                    var row = $('<tr>');

                    for (var prop in element.props) {
                        var $cell = $('<td>');
                        if (prop == "code") {
                            var next = $('<a>');
                            next.attr("href", "#");
                            next.attr("data-next", "/" + element.props[prop]);
                            next.html(element.props[prop]);
                            next.appendTo($cell);
                        } else {
                            $cell.text(element.props[prop]); //TODO make an href for the code property on the embedded resource
                        }
                        $cell.appendTo(row);
                    }

                    row.appendTo($table);
                });

                $table.appendTo($target);

                var $links = $('#links');

                if (root.links.next) {
                    var next = $('<a>');
                    next.attr("href", "#");
                    next.attr("data-next", root.links.next.href);
                    next.html("next");
                    next.appendTo($links);
                }

                if (root.links.prev) {
                    var prev = $('<a>');
                    prev.attr("href", "#");
                    prev.attr("data-next", root.links.prev.href);
                    prev.html("prev");
                    prev.appendTo($links);
                }

            }, function(err) {
                console.warn('Error fetching API root', err);
            });
        }

        function renderDetails(url) {
            clear();
            var api = new Hyperagent.Resource(url);
            api.fetch().then(function(root) {
                    var $detail = $('#detail');
                    
                    var code = $('<p>');
                    code.text(root.props.code);
                    code.appendTo($detail);
                    
                    var meaning = $('<p>');
                    meaning.text(root.props.meaning);
                    meaning.appendTo($detail);
                    
                    var description = $('<p>');
                    description.text(root.props.description);
                    description.appendTo($detail);
                    
                    var image = $('<img>');
                    image.attr("src", root.props.imageurl);
                    image.appendTo($detail);
                
                    var $links = $('#links');
                    if (root.links.index) {
                        var home = $('<a>');
                        home.attr("href", "#");
                        home.attr("data-next", root.links.index.href);
                        home.html("home");
                        home.appendTo($links);
                    }


                },
                function(err) {
                    console.warn('Error fetching API root', err);
                });
        }

        function clear() {
            var $detail = $('#detail');
            $detail.html('');

            var $target = $('#statuses');
            $target.html('');

            var $links = $('#links');
            $links.html('');
        }
    </script>
</body>

</html>